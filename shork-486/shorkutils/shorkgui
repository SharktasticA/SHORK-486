#!/bin/sh

if [ -f /etc/shorkcol.conf ]; then
    . /etc/shorkcol.conf
else
    NAME="white"
    ASCII="0;37"
fi

TERM_WIDTH=$(stty size 2>/dev/null | cut -d' ' -f2)

if [ ! -e /dev/fb0 ]; then
    printf "ERROR: No framebuffer device has been found. This could be due to using a non-VESA-compatible graphics card or resolution, or @NAME@ was built without kernel-level framebuffer, VESA and enhanced VGA support. Try using \033[32mshorkres\033[${ASCII}m to switch to \"vga\" or higher resolution, and if that does not work, verify if kernel-level support is included as per @NAME@'s after-build report.\n" | fold -s -w "$TERM_WIDTH"
    exit 1
fi

cleanup()
{
    [ -n "$X_PID" ] && kill "$X_PID" 2>/dev/null
    rm -f /tmp/shorkgui.twmrc 2>/dev/null
}
trap cleanup EXIT INT TERM



FB_WIDTH=$(cat /sys/class/graphics/fb0/virtual_size | cut -d',' -f1)
FONT_DIR="/usr/lib/X11/fonts/misc"
MODE="dark"

for arg in "$@"; do
    case "$arg" in
        --light|--passive)
            MODE="light"
            ;;
    esac
done

export DISPLAY=:0
export FONTCONFIG_PATH=/etc/fonts
export FONTCONFIG_FILE=/etc/fonts/fonts.conf

Xfbdev :0 -mouse /dev/input/mice -mouse /dev/ttyS0 -fp $FONT_DIR 2>/dev/null &
X_PID=$!

MAX_RETRIES=15
COUNT=0
while ! xset -q >/dev/null 2>&1; do
    sleep 1
    COUNT=$((COUNT + 1))
    if [ $COUNT -ge $MAX_RETRIES ]; then
        printf "\nERROR: Xfbdev failed to respond after $MAX_RETRIES seconds.\n" | fold -s -w "$TERM_WIDTH"
        exit 1
    elif ! kill -0 $X_PID 2>/dev/null; then
        printf "\nERROR: Xfbdev exited unexpectedly.\n" | fold -s -w "$TERM_WIDTH"
        exit 1
    fi
done

if [ $MODE == "light" ]; then 
    xli -onroot -center -border white -quiet /usr/share/backgrounds/shork-486-light.png
    sed "s/@FB_WIDTH@/$FB_WIDTH/g" /usr/share/X11/twm/light.twmrc > /tmp/shorkgui.twmrc
else
    xli -onroot -center -border black -quiet /usr/share/backgrounds/shork-486-dark.png
    sed "s/@FB_WIDTH@/$FB_WIDTH/g" /usr/share/X11/twm/dark.twmrc > /tmp/shorkgui.twmrc
fi

twm -f /tmp/shorkgui.twmrc
